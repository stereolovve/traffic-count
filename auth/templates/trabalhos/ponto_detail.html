{% extends "base.html" %}
{% block content %}
  {% if messages %}
    {% for msg in messages %}
      <div class="p-4 mb-4 text-white bg-blue-500 rounded">{{ msg }}</div>
    {% endfor %}
  {% endif %}
  <div class="max-w-3xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow sm:rounded-lg p-6">
      <h1 class="text-3xl font-bold text-gray-900">{{ ponto.nome }}</h1>
      <p class="mt-1 text-sm text-gray-600">Código: {{ ponto.codigo }}</p>
      <p class="mt-1 text-sm text-gray-600">Localização: {{ ponto.localizacao }}</p>
    </div>

    <!-- Card de Movimentos -->
    <div class="mt-8 bg-white shadow sm:rounded-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Movimentos</h2>
        <button type="button" id="addMovimentoBtn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Adicionar Movimento
        </button>
      </div>
      <div class="mt-4 space-y-4" id="movimentos-container">
        {% if details %}
          {% for detail in details %}
            {% if detail.movimento %}
              <div class="p-4 border rounded-lg">
                <p class="font-medium text-gray-700">{{ detail.movimento }}</p>
                <p class="text-sm text-gray-500">{{ detail.created_at|date:"d/m/Y H:i" }}</p>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <p class="text-gray-500">Nenhum movimento cadastrado.</p>
        {% endif %}
      </div>
      <!-- Form para adicionar movimento -->
      <div id="movimento-form" class="hidden mt-4 p-4 border rounded-lg">
        <form method="post" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="movimento">
          <div>
            <label for="movimento" class="block text-sm font-medium text-gray-700">Descrição do Movimento</label>
            <input type="text" name="movimento" id="movimento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Salvar Movimento
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Card de Observações -->
    <div class="mt-8 bg-white shadow sm:rounded-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Observações</h2>
        <button type="button" id="addObservacaoBtn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Adicionar Observação
        </button>
      </div>
      <div class="mt-4 space-y-4">
        {% if details %}
          {% for detail in details %}
            {% if detail.observacao %}
              <div class="p-4 border rounded-lg">
                <p class="mt-2 text-gray-700">{{ detail.observacao }}</p>
                <p class="text-sm text-gray-500 mt-2">{{ detail.created_at|date:"d/m/Y H:i" }}</p>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <p class="text-gray-500">Nenhuma observação cadastrada.</p>
        {% endif %}
      </div>
      <!-- Form para adicionar observação -->
      <div id="observacao-form" class="hidden mt-4 p-4 border rounded-lg">
        <form method="post" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="observacao">
          <div>
            <label for="observacao" class="block text-sm font-medium text-gray-700">Observação</label>
            <textarea name="observacao" id="observacao" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div>
            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Salvar Observação
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Card de Croquis -->
    <div class="mt-8 bg-white shadow sm:rounded-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Croquis</h2>
        <button type="button" id="addCroquisBtn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Adicionar Croqui
        </button>
      </div>
      <div class="mt-4 grid grid-cols-3 gap-4">
        {% if details %}
          {% for detail in details %}
            {% if detail.images.all %}
              {% for img in detail.images.all %}
                <div class="p-2 border rounded-lg">
                  <a href="{{ img.image.url }}" target="_blank">
                    <img src="{{ img.image.url }}" alt="Croqui" class="w-full h-32 object-cover rounded-md cursor-pointer" />
                  </a>
                  <p class="text-sm text-gray-500 mt-2">{{ detail.created_at|date:"d/m/Y H:i" }}</p>
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% else %}
          <p class="text-gray-500 col-span-3">Nenhum croqui cadastrado.</p>
        {% endif %}
      </div>
      <!-- Form para adicionar croqui -->
      <div id="croqui-form" class="hidden mt-4 p-4 border rounded-lg">
        <form method="post" enctype="multipart/form-data" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="croqui">
          <div>
            <label for="imagens" class="block text-sm font-medium text-gray-700">Selecione os arquivos PNG</label>
            <input type="file" name="imagens" id="imagens" accept=".png" multiple class="mt-1 block w-full text-gray-600">
            <p class="text-xs text-gray-500 mt-1">Segure Ctrl (ou Shift) para selecionar múltiplos arquivos.</p>
            <div id="croqui-preview" class="mt-2 grid grid-cols-4 gap-4"></div>
          </div>
          <div>
            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Salvar Croquis
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Botões para mostrar/esconder formulários
      const addMovimentoBtn = document.getElementById('addMovimentoBtn');
      const addObservacaoBtn = document.getElementById('addObservacaoBtn');
      const addCroquisBtn = document.getElementById('addCroquisBtn');
      
      const movimentoForm = document.getElementById('movimento-form');
      const observacaoForm = document.getElementById('observacao-form');
      const croquisForm = document.getElementById('croqui-form');
      
      // Toggle formulário de movimento
      if (addMovimentoBtn && movimentoForm) {
        addMovimentoBtn.addEventListener('click', () => {
          movimentoForm.classList.toggle('hidden');
          if (observacaoForm) observacaoForm.classList.add('hidden');
          if (croquisForm) croquisForm.classList.add('hidden');
        });
      }
      
      // Toggle formulário de observação
      if (addObservacaoBtn && observacaoForm) {
        addObservacaoBtn.addEventListener('click', () => {
          observacaoForm.classList.toggle('hidden');
          if (movimentoForm) movimentoForm.classList.add('hidden');
          if (croquisForm) croquisForm.classList.add('hidden');
        });
      }
      
      // Toggle formulário de croqui
      if (addCroquisBtn && croquisForm) {
        addCroquisBtn.addEventListener('click', () => {
          croquisForm.classList.toggle('hidden');
          if (movimentoForm) movimentoForm.classList.add('hidden');
          if (observacaoForm) observacaoForm.classList.add('hidden');
        });
      }
      
      // Preview para croquis
      const croquisInput = document.getElementById('imagens');
      const croquisPreview = document.getElementById('croqui-preview');
      
      if (croquisInput && croquisPreview) {
        croquisInput.addEventListener('change', () => {
          croquisPreview.innerHTML = '';
          Array.from(croquisInput.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'w-24 h-24 object-cover rounded-md';
              croquisPreview.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        });
      }
    });
  </script>
{% endblock %}